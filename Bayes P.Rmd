---
title: "Bayes"
author: "GPF"
date: "2022-12-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

```{r packages}
needed_packages = c("invgamma", "cmdstanr", "HDInterval", "bayesplot","BiocManager","modeest", 'kableExtra', 'formattable', 'tidyverse')
for(i in 1:length(needed_packages)){
  haspackage = require(needed_packages[i], character.only = TRUE)
  if(haspackage == FALSE){
    install.packages(needed_packages[i])
  }
  library(needed_packages[i], character.only = TRUE)
}
rm(haspackage, needed_packages, i)
```

## Data
```{r}
# full data set
d <- read.csv(file = "https://raw.githubusercontent.com/Fran-Diaz-R/Bayes/main/data_full.csv")

# some data manipulation / item represents pairwise comparison
d <- d %>% mutate(
  item = paste(areaIncorrect, numIncorrect, sep = '_'),
  item = as.numeric(factor(item))) %>%
  arrange(item)

# we have balanced data per pidgeon, session and item
d %>% group_by(bird) %>% summarise(min_i = min(item),
                                   max_i = max(item),
                                   min_s = min(session),
                                   max_s = max(session))
#there is no missing data
sum(is.na(d$accuracy))

# important variables
data <- d %>% select(bird, accuracy, session, Euclidean, CityBlock, item)
colnames(data) <- c('Bird', 'y', 'Session', 'Euclidean', 'Cityblock', 'Item')
```

## Sample
```{r}
desc <- data %>% group_by(Bird) %>% summarise(
                                   Items = max(Item),
                                   Sessions = max(Session),
                                   Responses = n(),
                                   Avg_Outcome = mean(y))

kable_styling(kable(desc,
                    digits = 3,
                    col.names = c('Bird', 'Items', 'Sessions', 'Responses', 'Avg. Outcomes'),
                    caption = 'Descriptive statistics of sample',
                    align = 'lcccc'),
              bootstrap_options = c('hover', 'responsive', 'bordered'),
              full_width = F, position = 'center', font_size =12)
```


```{r}
## City-Block Model
CityBlock_Model_Syntax = "

data {
  int<lower=0> N;
  vector[N] c;
  int<lower=0, upper=1> y[N];
}

parameters {
  real beta0;
  real betac;
}

## number of successes out of 2 trials (per day)
model {
  acc ~ binomial(2,inv_logit(alpha + betaC * cityblock + betaD * session));
}

generated quantities (R2)

Model comparison
For each value of acc in the iteration, get the LL
"
```

```{r}
CityBlock_Model_Stan = cmdstan_model(stan_file = write_stan_file(CityBlock_Model_Syntax))

mode04_StanData = list(
  N = nrow(Data),
  acc = Data$accuracy,
  cityblock = Data$CityBlock
)

CityBlock_Model_Samples = CityBlock_Model_Stan$sample(
  data = mode04_StanData,
  seed = 190920221,
  chains = 4,
  parallel_chains = 4,
  iter_warmup = 4000,
  iter_sampling = 4000
)

# assess convergence: summary of all parameters
CityBlock_Model_Samples$summary()

# maximum R-hat
max(CityBlock_Model_Samples$summary()$rhat, na.rm = TRUE)
```


```{r}
## Euclidean Model
Euclidean_Model_Syntax = "
data {
  int<lower=0> N;
  vector[N] Euclidean;
  int<lower=0, upper=1> acc[N];
}

parameters {
  real alpha;
  real beta;
}

model {
  acc ~ bernoulli_logit(alpha + beta * Euclidean);
}

"

Euclidean_Model_Stan = cmdstan_model(stan_file = write_stan_file(Euclidean_Model_Syntax))

mode04_StanData = list(
  N = nrow(Data),
  acc = Data$accuracy,
  Euclidean = Data$Euclidean
)

Euclidean_Model_Samples = Euclidean_Model_Stan$sample(
  data = mode04_StanData,
  seed = 190920221,
  chains = 4,
  parallel_chains = 4,
  iter_warmup = 4000,
  iter_sampling = 4000
)

# assess convergence: summary of all parameters
Euclidean_Model_Samples$summary()

# maximum R-hat
max(Euclidean_Model_Samples$summary()$rhat, na.rm = TRUE)
```
